# 双模式构建Monorepo系统任务规划

## 任务概述

本文档详细规划了双模式构建Monorepo系统的实施任务，按照5个主要阶段进行，确保项目能够平滑迁移到新架构并实现所有目标功能。

## 阶段1：Monorepo架构搭建

### 任务1.1：创建根目录结构和配置文件 ✅
**优先级**: 高  
**预估时间**: 2小时  
**依赖**: 无  

**具体任务**:
- [x] 创建新的项目根目录结构
- [x] 配置 `pnpm-workspace.yaml`
- [x] 创建根 `package.json` 配置workspace
- [x] 设置 `.gitignore` 和基础配置文件
- [x] 创建 `vite.config.base.js` 基础配置

**验收标准**:
- ✅ pnpm workspace 正确识别所有子包
- ✅ 根目录可以执行 `pnpm install` 成功
- ✅ 基础目录结构符合设计文档

### 任务1.2：迁移现有代码到packages结构 ✅
**优先级**: 高  
**预估时间**: 3小时  
**依赖**: 任务1.1  

**具体任务**:
- [x] 将 `vite-migration` 内容迁移到 `packages/screenshot-splitter/`
- [x] 创建 `packages/shared-components/` 共享组件库
- [x] 创建 `packages/ui-library/` 统一UI组件库
- [x] 更新各包的 `package.json` 配置
- [x] 调整导入路径和依赖关系

**验收标准**:
- ✅ 所有代码成功迁移，无丢失
- ✅ 包之间的依赖关系正确配置
- ✅ 各包可以独立构建（SPA和单文件模式都成功）

### 任务1.3：配置共享依赖和构建脚本 ✅
**优先级**: 中  
**预估时间**: 2小时  
**依赖**: 任务1.2  

**具体任务**:
- [x] 配置共享的devDependencies
- [x] 创建统一的构建脚本
- [x] 设置代码格式化和检查工具
- [x] 配置TypeScript项目引用
- [x] 创建开发环境启动脚本

**验收标准**:
- ✅ 可以通过根目录命令管理所有子包
- ✅ 代码格式化和检查正常工作
- ✅ 开发环境可以正常启动

## 阶段2：双模式构建系统

### 任务2.1：实现基础vite配置系统 ✅
**优先级**: 高  
**预估时间**: 4小时  
**依赖**: 任务1.3  

**具体任务**:
- [x] 创建 `vite.config.base.js` 基础配置函数
- [x] 实现模式切换逻辑 (singlefile/spa)
- [x] 配置环境变量支持
- [x] 创建各包专用的vite配置文件
- [x] 测试基础构建功能

**验收标准**:
- ✅ 可以通过环境变量切换构建模式
- ✅ 基础构建配置正常工作
- ✅ 各包可以使用共享配置

### 任务2.2：集成vite-plugin-singlefile和外部库支持 ✅
**优先级**: 高  
**预估时间**: 3小时  
**依赖**: 任务2.1  

**具体任务**:
- [x] 安装和配置 `vite-plugin-singlefile`
- [x] 安装和配置 `vite-plugin-externals`
- [x] 配置CDN外部库映射 (React, ReactDOM等)
- [x] 优化单文件构建配置
- [x] 测试单文件输出功能

**验收标准**:
- ✅ 单文件模式可以正确内联所有资源
- ✅ 外部库通过CDN正确加载
- ✅ 生成的HTML文件可以独立运行

### 任务2.3：完善构建脚本和命令 ✅
**优先级**: 中  
**预估时间**: 2小时  
**依赖**: 任务2.2  

**具体任务**:
- [x] 创建统一的构建管理脚本
- [x] 添加构建前的检查流程 (类型检查、代码检查)
- [x] 实现构建报告生成
- [x] 创建部署预览脚本
- [x] 优化构建脚本的错误处理

**验收标准**:
- ✅ 可以通过单一命令执行完整构建流程
- ✅ 构建前自动执行必要的检查
- ✅ 生成详细的构建报告
- ✅ 支持本地预览构建结果

## 阶段3：组件独立化

### 任务3.1：长截图分割工具独立包配置 ✅
**优先级**: 高  
**预估时间**: 3小时  
**依赖**: 任务2.3  

**具体任务**:
- [x] 配置 `packages/screenshot-splitter` 独立构建
- [x] 创建独立的 `index.html` 入口文件
- [x] 配置独立的路由和状态管理
- [x] 设置组件专用的vite配置
- [x] 创建组件配置文件和部署准备脚本
- [x] 测试独立构建和运行

**验收标准**:
- ✅ 组件可以独立构建和运行
- ✅ 功能完整，不依赖其他组件
- ✅ 支持两种构建模式（SPA + 单文件）
- ✅ 具备完整的组件配置和元数据
- ✅ 支持独立部署准备流程

### 任务3.2：实现组件独立路由系统 ✅
**优先级**: 中  
**预估时间**: 2小时  
**依赖**: 任务3.1  

**具体任务**:
- [x] 设计组件路由配置结构
- [x] 实现路由注册和管理系统
- [x] 配置独立访问路径
- [x] 添加路由导航和面包屑
- [x] 创建路由Hook和管理器
- [x] 集成导航组件到App
- [x] 测试路由功能

**验收标准**:
- ✅ 组件可以通过独立URL访问
- ✅ 路由系统工作正常
- ✅ 支持浏览器前进后退
- ✅ 具备完整的导航和面包屑功能
- ✅ 支持路由守卫和事件系统

### 任务3.3：组件解耦和接口标准化 ✅
**优先级**: 中  
**预估时间**: 3小时  
**依赖**: 任务3.2  

**具体任务**:
- [x] 定义组件间通信接口
- [x] 抽取共享逻辑到shared-components
- [x] 实现组件生命周期管理
- [x] 标准化组件配置和元数据
- [x] 添加组件版本管理

**验收标准**:
- ✅ 组件之间完全解耦
- ✅ 共享逻辑正确抽取
- ✅ 组件接口标准化

### 任务3.4：GitHub Actions自动化部署配置 ✅
**优先级**: 高  
**预估时间**: 4小时  
**依赖**: 任务3.3  

**具体任务**:
- [x] 创建 `.github/workflows/deploy.yml`
- [x] 配置pnpm和Node.js环境
- [x] 设置双模式构建流程
- [x] 配置GitHub Pages部署
- [x] 添加构建状态检查和错误处理

**验收标准**:
- ✅ GitHub Actions可以正常运行
- ✅ 构建环境配置正确
- ✅ 支持双模式构建和部署

### 任务3.5：组件库索引页面开发 ✅
**优先级**: 中  
**预估时间**: 3小时  
**依赖**: 任务3.4  

**具体任务**:
- [x] 创建组件库索引页面组件
- [x] 实现组件搜索和分类功能
- [x] 添加组件信息展示和链接
- [x] 设计响应式布局和样式
- [x] 集成组件演示和文档链接

**验收标准**:
- ✅ 组件库索引页面功能完整
- ✅ 支持搜索和分类筛选
- ✅ 响应式设计良好
- ✅ 组件信息展示清晰

## 阶段4：自动化部署

### 任务4.1：配置GitHub Actions基础工作流 ✅
**优先级**: 高  
**预估时间**: 3小时  
**依赖**: 任务3.5  

**具体任务**:
- [x] 创建 `.github/workflows/deploy.yml`
- [x] 配置pnpm和Node.js环境
- [x] 设置构建缓存策略
- [x] 配置环境变量和密钥
- [x] 测试基础工作流

**验收标准**:
- ✅ GitHub Actions可以正常运行
- ✅ 构建环境配置正确
- ✅ 缓存策略有效提升构建速度

### 任务4.2：实现多目标部署逻辑 ✅
**优先级**: 高  
**预估时间**: 4小时  
**依赖**: 任务4.1  

**具体任务**:
- [x] 配置主应用部署到GitHub Pages
- [x] 实现组件独立部署逻辑
- [x] 设置多分支部署策略
- [x] 配置自定义域名支持
- [x] 添加部署状态检查

**验收标准**:
- ✅ 主应用可以正确部署到GitHub Pages
- ✅ 独立组件可以单独部署
- ✅ 部署状态可以正确反馈

### 任务4.3：添加部署监控和错误处理 ✅
**优先级**: 中  
**预估时间**: 2小时  
**依赖**: 任务4.2  

**具体任务**:
- [x] 实现部署失败通知
- [x] 添加自动回滚机制
- [x] 配置部署日志收集
- [x] 设置健康检查端点
- [x] 创建部署状态页面

**验收标准**:
- ✅ 部署失败时有明确通知
- ✅ 回滚机制正常工作
- ✅ 部署状态可以实时查看

## 阶段5：测试和优化

### 任务5.1：完善测试覆盖率 ✅
**优先级**: 中  
**预估时间**: 4小时  
**依赖**: 任务4.3  

**具体任务**:
- [x] 添加单元测试覆盖关键功能
- [x] 实现集成测试验证构建流程
- [x] 配置端到端测试验证部署
- [x] 设置测试自动化运行
- [x] 生成测试覆盖率报告

**验收标准**:
- ✅ 关键功能有单元测试覆盖
- ✅ 构建和部署流程有集成测试
- ✅ 测试可以自动运行并生成报告

### 任务5.2：性能优化和体积优化 ✅
**优先级**: 中  
**预估时间**: 3小时  
**依赖**: 任务5.1  

**具体任务**:
- [x] 分析构建产物体积
- [x] 优化单文件HTML大小
- [x] 配置代码分割策略
- [x] 优化CDN资源加载
- [x] 实现懒加载和预加载

**验收标准**:
- ✅ 构建产物体积在合理范围
- ✅ 页面加载性能良好
- ✅ 资源加载策略优化

### 任务5.3：文档完善和示例添加 ✅
**优先级**: 低  
**预估时间**: 3小时  
**依赖**: 任务5.2  

**具体任务**:
- [x] 编写完整的开发文档
- [x] 创建部署指南
- [x] 添加使用示例和最佳实践
- [x] 制作组件使用演示
- [x] 创建故障排除指南

**验收标准**:
- ✅ 文档完整清晰
- ✅ 示例可以正常运行
- ✅ 新开发者可以快速上手

### 任务5.4：部署验证和问题修复 ✅
**优先级**: 高  
**预估时间**: 2小时  
**依赖**: 任务5.3  

**具体任务**:
- [x] 验证GitHub Pages部署正常
- [x] 测试独立组件访问功能
- [x] 检查跨浏览器兼容性
- [x] 修复发现的问题
- [x] 进行最终验收测试

**验收标准**:
- ✅ 所有功能在GitHub Pages正常工作
- ✅ 跨浏览器兼容性良好
- ✅ 没有阻塞性问题

## 风险评估和缓解策略

### 高风险项
1. **Monorepo迁移复杂性**
   - 风险：代码迁移过程中可能丢失功能或引入bug
   - 缓解：分步迁移，每步都进行功能验证

2. **GitHub Pages部署限制**
   - 风险：GitHub Pages对单文件大小和功能有限制
   - 缓解：优化构建产物，使用CDN外部库

### 中风险项
1. **依赖版本冲突**
   - 风险：不同包之间可能存在依赖版本冲突
   - 缓解：使用pnpm的严格依赖管理

2. **构建性能问题**
   - 风险：Monorepo结构可能导致构建时间增长
   - 缓解：合理配置缓存和并行构建

## 成功标准

### 功能标准
- [ ] 双模式构建系统正常工作
- [ ] 长截图分割工具可以独立访问
- [ ] GitHub Pages部署成功且功能正常
- [ ] Monorepo架构清晰且易于维护

### 性能标准
- [ ] 单文件HTML大小 < 5MB
- [ ] 页面首次加载时间 < 3秒
- [ ] 构建时间 < 5分钟
- [ ] 部署时间 < 10分钟

### 质量标准
- [ ] 代码测试覆盖率 > 80%
- [ ] 无严重安全漏洞
- [ ] 跨浏览器兼容性良好
- [ ] 文档完整且准确

## 时间估算

**总预估时间**: 40小时  
**建议实施周期**: 2-3周  
**关键里程碑**:
- 第1周：完成阶段1-2（Monorepo架构 + 双模式构建）
- 第2周：完成阶段3-4（组件独立化 + 自动化部署）
- 第3周：完成阶段5（测试优化 + 文档完善）