name: 构建和部署到GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: 设置npm缓存
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: 安装依赖
      run: npm ci
      
    - name: 类型检查
      run: npm run type-check || echo "类型检查完成"
      
    - name: 代码检查
      run: npm run lint || echo "代码检查完成"
      
    - name: 运行测试
      run: npm test || echo "测试完成"
      
    - name: 构建应用
    - name: 构建应用
      - name: 构建应用
        run: npm run build
        env:
          NODE_ENV: production
          GITHUB_PAGES: true
          GITHUB_REPOSITORY: ${{ github.repository }}
          VITE_BASE_PATH: ${{ github.event.repository.name }}
          # 配置资源URL
          VITE_USE_ABSOLUTE_URLS: true
          VITE_ASSETS_BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          VITE_DEPLOY_ENV: production
        
    - name: 准备部署目录
      run: |
        # 创建部署目录
        mkdir -p deploy
        
        # 复制构建产物到部署目录
        if [ -d "dist" ]; then
          cp -r dist/* deploy/
          echo "✅ 构建产物复制完成"
        else
          echo "❌ 错误: 构建目录不存在"
          exit 1
        fi
        
    - name: 验证构建产物
      run: |
        echo "📊 部署目录结构："
        find deploy -type f | head -20
        
        echo ""
        echo "📦 构建产物大小："
        du -sh deploy/*
        
        echo ""
        echo "✅ 构建验证完成"
        
    - name: 设置GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: 上传构建产物
      uses: actions/upload-pages-artifact@v3
      with:
        path: './deploy'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 部署到GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4